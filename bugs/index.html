<!DOCTYPE html>
<html lang="en">
<head>
  <title>FuTURES続 Lab - Reported Bugs</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="FuTURES続 Lab regularly reports software logic bugs and security vulnerabilities as part of our research. View our continually updated list of discovered issues.">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">

  <!-- Bootstrap 3 + jQuery -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

  <!-- Icons + Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons/css/academicons.min.css">
  <link href="../css/main.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Work Sans" rel="stylesheet">

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

  <!-- DOMPurify (XSS protection for query params) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>

  <style>
    body { font-family: 'Work Sans', sans-serif; }
    .main-container { margin-top: 1.15em; }
    .counter { transition: opacity .25s ease; opacity: 0; color: #BE0000; }

    /* Top bar (search left, summary right) */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }
    .top-left { display: flex; align-items: center;}
    .top-right { font-size: 0.95em; color: #555; white-space: normal; flex-wrap: wrap;}
    /* make the DataTables search input a bit wider */
    div.dataTables_filter label input { width: 220px; }
  </style>

  <script>
    // Accept both ?q= and ?search= (sanitized)
    function getSanitizedQueryParamAny() {
      const urlParams = new URLSearchParams(window.location.search);
      const names = ['q', 'search'];
      for (const n of names) {
        const v = urlParams.get(n);
        if (v) return DOMPurify.sanitize(v);
      }
      return null;
    }

    function animateCounter(element, targetValue, duration) {
      let startValue = 0;
      const increment = Math.ceil(targetValue / (duration / 20));
      const interval = setInterval(() => {
        startValue += increment;
        if (startValue >= targetValue) {
          element.textContent = targetValue;
          clearInterval(interval);
        } else {
          element.textContent = startValue;
        }
      }, 20);
    }

    async function loadBugData() {
      const jsonFiles = [
        'ZaoYang.json',
        'YeaseenArafat.json',
        'GabeSherman.json',
        'DillonOtto.json',
        'TannerRowlett.json'
      ];

      const tableBody = document.getElementById("table-body");
      const loadingRow = document.getElementById("loading");
      const bugCountElement = document.getElementById("bug-count");
      const counterContainer = document.querySelector('.counter');

      let allBugs = [];

      try {
        // Fetch & merge all JSON files
        for (const file of jsonFiles) {
          const resp = await fetch(file);
          if (!resp.ok) throw new Error("Failed to fetch " + file + ": " + resp.statusText);
          const bugs = await resp.json();
          allBugs = allBugs.concat(bugs);
        }

        // Render rows
        loadingRow.remove();
        allBugs.forEach(bug => {
          const row = `<tr>
            <td>${bug.date}</td>
            <td><a href="${bug.url}" target="_blank" rel="noopener noreferrer">${bug.id}</a>: ${bug.desc}</td>
            <td>${bug.lead}</td>
          </tr>`;
          tableBody.insertAdjacentHTML('beforeend', row);
        });

        // Animate big counter
        animateCounter(bugCountElement, allBugs.length, 1000);
        counterContainer.style.opacity = 1;

        // Initialize DataTable with custom top bar (search left, summary right)
        const table = $('#security-bugs').DataTable({
          order: [[0, "desc"]],
          paging: true,
          searching: true,
          responsive: true,
          pageLength: 25,
          lengthChange: false,
          info: false,
          dom: '<"top-bar"<"top-left"f><"top-right"i>>t<"bottom"p>',
          columnDefs: [
            { type: "date", targets: 0 },
            { orderable: false, targets: 2 }
          ]
        });

        // Fix invalid aria-role attributes generated by DataTables
        function fixAriaRoles() {
          $('[aria-role]').each(function() {
            const ariaRole = $(this).attr('aria-role');
            $(this).removeAttr('aria-role').attr('role', ariaRole);
          });
        }
        fixAriaRoles();
        table.on('draw', fixAriaRoles);

        // Custom summary span
        $('.top-right').html('<span id="results-banner" aria-live="polite"></span>');
        const bannerEl = document.getElementById('results-banner');
        const totalCount = allBugs.length;

        function renderBanner() {
          const query = ($('#security-bugs_filter input').val() || '').trim();
          const filtered = table.rows({ search: 'applied' }).count();
          bannerEl.textContent = query
            ? `Showing ${filtered} results for "${query}" (out of ${totalCount} total).`
            : `Showing all ${totalCount} entries.`;
        }

        table.on('draw', renderBanner);

        // Apply query from URL (supports ?q= and ?search=)
        const searchQuery = getSanitizedQueryParamAny();
        if (searchQuery) {
          table.search(searchQuery).draw();
        } else {
          table.draw();
        }

        // Keep URL in sync
        $('#security-bugs_filter input').on('input', function () {
          const newQuery = this.value.trim();
          const newUrl = newQuery ? `?search=${encodeURIComponent(newQuery)}` : window.location.pathname;
          window.history.replaceState(null, '', newUrl);
        });

      } catch (err) {
        console.error("Error loading bug data:", err);
        if (loadingRow) {
          loadingRow.innerHTML = `<td colspan="3" style="text-align:center;color:red;">Failed to load data.</td>`;
        }
      }
    }

    document.addEventListener("DOMContentLoaded", loadBugData);
  </script>
</head>

<body>
  <div id="navbar-placeholder"></div>

  <main id="main-content" role="main">
    <div class="container main-container">
      <div class="col-md-12 text-center" style="margin-bottom:10px">
        <h1>FuTURES続 Lab <br class="on-narrow"> Reported Bugs:
          <span class="counter" id="bug-count" aria-live="polite">0</span>
        </h1>
      </div>

      <div class="col-md-12" style="margin-bottom:15px">
        <p style="text-align: justify;">
          We regularly report new software logic bugs and security vulnerabilities as part of our research.
          Below is a continually updated list:
        </p>
      </div>

      <div class="col-md-12 table-responsive">
        <table id="security-bugs" class="display table table-striped table-bordered" style="width:100%" role="table" aria-label="Security bugs and vulnerabilities reported by FuTURES続 Lab">
          <thead>
            <tr>
              <th scope="col" style="width:12%">Date</th>
              <th scope="col" style="width:68%">Description</th>
              <th scope="col" style="width:20%">Lead</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr id="loading">
              <td colspan="3" style="text-align:center;">Loading data, please wait...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <br>

  <div id="footer-placeholder"></div>

  <script src="../includes/load-includes.js"></script>
</body>
</html>
